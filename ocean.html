<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>海浪模拟</title>
  <style>
    :root{
      --panel-bg: rgba(10, 22, 30, 0.42);
      --panel-brd: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --accent: rgba(120, 210, 255, 0.90);
      --shadow: rgba(0,0,0,0.35);
      --err-bg: rgba(0,0,0,0.55);
      --err-brd: rgba(255,80,80,0.35);
    }
    html,body{
      height:100%;
      margin:0;
      overflow:hidden;
      background: radial-gradient(1200px 700px at 70% 20%, #1a5466 0%, #0a2230 45%, #06161f 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC","Microsoft YaHei", Arial;
      color: var(--text);
    }
    #app{ position:fixed; inset:0; }
    canvas{ display:block; width:100%; height:100%; }

    .panel{
      position:fixed; left:16px; top:16px;
      width:min(360px, calc(100% - 32px));
      padding:14px 14px 12px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-brd);
      border-radius: 14px;
      box-shadow: 0 10px 30px var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select:none;
    }
    .title{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .title h1{ font-size:16px; letter-spacing:0.5px; margin:0; font-weight:650; }
    .title .hint{ font-size:12px; color: var(--muted); white-space:nowrap; }
    .row{
      display:grid;
      grid-template-columns: 92px 1fr 64px;
      align-items:center; gap:10px; padding:8px 0;
    }
    .label{ font-size:13px; color: var(--muted); }
    input[type="range"]{ width:100%; accent-color: var(--accent); }
    .val{ font-variant-numeric: tabular-nums; font-size:13px; text-align:right; color: rgba(255,255,255,0.88); }
    .footer{
      margin-top:10px; padding-top:10px;
      border-top: 1px solid rgba(255,255,255,0.10);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.88);
      padding:8px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{ background: rgba(255,255,255,0.09); }
    .note{ font-size:12px; color: rgba(255,255,255,0.62); line-height:1.35; }

    .badge{
      position: fixed; right: 14px; bottom: 14px;
      padding: 8px 10px; border-radius: 12px;
      background: rgba(10, 22, 30, 0.28);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 10px 24px rgba(0,0,0,0.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.70);
      font-size: 12px;
      letter-spacing: 0.2px;
    }

    /* 错误面板：GitHub Pages 黑屏时能直接看到原因 */
    #errBox{
      position:fixed; right:16px; top:16px;
      width:min(520px, calc(100% - 32px));
      background: var(--err-bg);
      border: 1px solid var(--err-brd);
      border-radius: 14px;
      padding: 12px 12px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
    }
    #errBox .t{ font-size:13px; font-weight:650; margin:0 0 6px 0; color: rgba(255,220,220,0.95); }
    #errBox pre{
      margin:0;
      font-size:12px;
      color: rgba(255,235,235,0.90);
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <div class="panel" aria-label="控制面板">
    <div class="title">
      <h1>海浪模拟</h1>
      <div class="hint">宁静 · 真实 · 可调</div>
    </div>

    <div class="row">
      <div class="label">风速</div>
      <input id="wind" type="range" min="0" max="30" step="0.1" value="8" />
      <div class="val" id="windVal">8.0</div>
    </div>

    <div class="row">
      <div class="label">浪高</div>
      <input id="height" type="range" min="0" max="5" step="0.01" value="1.2" />
      <div class="val" id="heightVal">1.20</div>
    </div>

    <div class="row">
      <div class="label">光照</div>
      <input id="light" type="range" min="0.2" max="2.0" step="0.01" value="1.0" />
      <div class="val" id="lightVal">1.00</div>
    </div>

    <div class="footer">
      <button class="btn" id="reset">恢复默认</button>
      <div class="note">提示：调低风速与浪高更“平静”；提高光照增强反射与高光闪烁。</div>
    </div>
  </div>

  <div id="errBox" aria-live="polite">
    <div class="t">检测到运行错误（这通常就是黑屏原因）</div>
    <pre id="errText"></pre>
  </div>

  <div class="badge">WebGL 海面着色器 · Gerstner Waves</div>

  <!-- 用全局 three.min.js，避免 GitHub Pages 上 ESM 模块加载/MIME/404 问题 -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <script>
    (function(){
      const errBox = document.getElementById("errBox");
      const errText = document.getElementById("errText");
      function showErr(msg){
        errBox.style.display = "block";
        errText.textContent = String(msg || "未知错误");
      }
      window.addEventListener("error", (e) => {
        showErr((e && (e.message || e.error)) ? (e.message || e.error) : e);
      });
      window.addEventListener("unhandledrejection", (e) => {
        showErr(e && e.reason ? e.reason : e);
      });

      if (!window.THREE) {
        showErr("THREE 未加载：请确认 three.min.js CDN 可访问（网络或被拦截）。");
        return;
      }

      const THREE = window.THREE;
      const app = document.getElementById("app");

      // WebGL 可用性检查
      try{
        const c = document.createElement("canvas");
        const gl = c.getContext("webgl") || c.getContext("experimental-webgl");
        if(!gl){
          showErr("当前环境无法创建 WebGL 上下文（浏览器/硬件/设置限制）。");
          return;
        }
      }catch(ex){
        showErr(ex);
        return;
      }

      // ---------- 基础场景 ----------
      const scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x06161f, 0.012);

      const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2000);
      camera.position.set(0, 28, 86);
      camera.lookAt(0, 0, 0);

      const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.05;
      app.appendChild(renderer.domElement);

      // ---------- 天空 ----------
      const skyGeo = new THREE.SphereGeometry(1200, 32, 16);
      const skyMat = new THREE.ShaderMaterial({
        side: THREE.BackSide,
        uniforms: {
          uTop: { value: new THREE.Color("#1f6a7a") },
          uBottom: { value: new THREE.Color("#06161f") },
          uOffset: { value: 20.0 },
          uExponent: { value: 0.85 }
        },
        vertexShader: `
          varying vec3 vWorldPos;
          void main(){
            vec4 worldPos = modelMatrix * vec4(position, 1.0);
            vWorldPos = worldPos.xyz;
            gl_Position = projectionMatrix * viewMatrix * worldPos;
          }
        `,
        fragmentShader: `
          varying vec3 vWorldPos;
          uniform vec3 uTop;
          uniform vec3 uBottom;
          uniform float uOffset;
          uniform float uExponent;
          void main(){
            float h = normalize(vWorldPos + vec3(0.0,uOffset,0.0)).y;
            float t = pow(max(h, 0.0), uExponent);
            vec3 col = mix(uBottom, uTop, t);
            gl_FragColor = vec4(col, 1.0);
          }
        `
      });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);

      // ---------- 海面 ----------
      const oceanUniforms = {
        uTime: { value: 0 },
        uWind: { value: 8.0 },
        uAmp:  { value: 1.2 },
        uLightStrength: { value: 1.0 },
        uSunDir: { value: new THREE.Vector3(0.35, 0.72, 0.55).normalize() },
        uDeepColor: { value: new THREE.Color("#06212b") },
        uShallowColor: { value: new THREE.Color("#0b6a73") },
        uSkyColor: { value: new THREE.Color("#1f6a7a") }
      };

      const oceanMat = new THREE.ShaderMaterial({
        uniforms: oceanUniforms,
        fog: false, // 避免不同 three 版本 fog 定义差异导致的潜在编译问题
        vertexShader: `
          uniform float uTime;
          uniform float uWind;
          uniform float uAmp;

          varying vec3 vWorldPos;
          varying vec3 vNormalW;
          varying float vFoamHint;

          vec3 gerstner(vec2 xz, vec2 dir, float wavelength, float steepness, float speed, float amp, out float crest){
            float k = 6.28318530718 / wavelength;
            float c = sqrt(9.8 / k) * speed;
            float f = k * (dot(dir, xz) - c * uTime);
            float a = amp / k;

            crest = pow(max(0.0, sin(f)*0.5 + 0.5), 3.0);

            float s = sin(f);
            float co = cos(f);

            float q = steepness / (k * a * 4.0 + 1.0);
            vec3 disp;
            disp.x = q * a * dir.x * co;
            disp.y = a * s;
            disp.z = q * a * dir.y * co;
            return disp;
          }

          vec3 oceanDisplacement(vec2 xz, out float foamCrest){
            vec3 d = vec3(0.0);
            float crestSum = 0.0;

            float wind = max(uWind, 0.0);
            float energy = mix(0.35, 1.0, clamp(wind / 22.0, 0.0, 1.0));
            float ampBase = uAmp * energy;

            vec2 d0 = normalize(vec2(0.86, 0.52));
            vec2 d1 = normalize(vec2(-0.25, 0.97));
            vec2 d2 = normalize(vec2(0.98, -0.20));
            vec2 d3 = normalize(vec2(-0.75, -0.66));

            float c;
            d += gerstner(xz, d0, 32.0, 0.95, 1.05 + wind*0.020, ampBase*1.00, c); crestSum += c*0.50;
            d += gerstner(xz, d1, 18.0, 0.85, 1.15 + wind*0.018, ampBase*0.55, c); crestSum += c*0.30;
            d += gerstner(xz, d2, 11.0, 0.75, 1.25 + wind*0.016, ampBase*0.32, c); crestSum += c*0.14;
            d += gerstner(xz, d3,  6.5, 0.62, 1.40 + wind*0.014, ampBase*0.18, c); crestSum += c*0.06;

            foamCrest = clamp(crestSum, 0.0, 1.0);
            return d;
          }

          void main(){
            vec3 pos = position;

            float crest;
            vec3 disp = oceanDisplacement(pos.xz, crest);
            pos += disp;

            float eps = 0.15;
            float c1; float c2;
            vec3 dispX = oceanDisplacement(position.xz + vec2(eps, 0.0), c1);
            vec3 dispZ = oceanDisplacement(position.xz + vec2(0.0, eps), c2);

            vec3 p  = vec3(position.x, 0.0, position.z) + disp;
            vec3 px = vec3(position.x + eps, 0.0, position.z) + dispX;
            vec3 pz = vec3(position.x, 0.0, position.z + eps) + dispZ;

            vec3 n = normalize(cross(pz - p, px - p));
            vec4 worldPos = modelMatrix * vec4(pos, 1.0);

            vWorldPos = worldPos.xyz;
            vNormalW = normalize(mat3(modelMatrix) * n);

            float slope = 1.0 - clamp(n.y, 0.0, 1.0);
            vFoamHint = clamp(crest * 0.75 + slope * 0.65, 0.0, 1.0);

            gl_Position = projectionMatrix * viewMatrix * worldPos;
          }
        `,
        fragmentShader: `
          uniform vec3 uSunDir;
          uniform float uLightStrength;
          uniform vec3 uDeepColor;
          uniform vec3 uShallowColor;
          uniform vec3 uSkyColor;

          varying vec3 vWorldPos;
          varying vec3 vNormalW;
          varying float vFoamHint;

          float hash(vec2 p){
            p = fract(p * vec2(123.34, 456.21));
            p += dot(p, p + 34.345);
            return fract(p.x * p.y);
          }

          void main(){
            vec3 N = normalize(vNormalW);
            vec3 V = normalize(cameraPosition - vWorldPos);
            vec3 L = normalize(uSunDir);

            float fresnel = pow(1.0 - max(dot(N, V), 0.0), 5.0);

            float up = clamp(N.y, 0.0, 1.0);
            vec3 waterBase = mix(uDeepColor, uShallowColor, pow(up, 2.0));

            float diff = max(dot(N, L), 0.0);
            vec3 diffuse = waterBase * (0.12 + 0.18 * diff) * uLightStrength;

            vec3 H = normalize(L + V);
            float spec = pow(max(dot(N, H), 0.0), 180.0);
            vec3 specular = vec3(1.0, 0.98, 0.92) * spec * (0.9 + 0.6 * uLightStrength);

            vec3 reflectedSky = mix(waterBase, uSkyColor, 0.9);
            vec3 col = mix(waterBase, reflectedSky, clamp(fresnel * 1.05, 0.0, 1.0));
            col += diffuse;
            col += specular;

            float n = hash(vWorldPos.xz * 0.35);
            float foam = smoothstep(0.58, 0.95, vFoamHint) * (0.6 + 0.4 * n);
            vec3 foamCol = vec3(0.92, 0.97, 1.0);
            col = mix(col, foamCol, foam * 0.65);

            float glitter = pow(max(dot(reflect(-L, N), V), 0.0), 80.0);
            col += vec3(1.0, 0.96, 0.85) * glitter * 0.12 * uLightStrength;

            gl_FragColor = vec4(col, 1.0);
          }
        `
      });

      const size = 1200;
      const seg = 320;
      const oceanGeo = new THREE.PlaneGeometry(size, size, seg, seg);
      oceanGeo.rotateX(-Math.PI / 2);

      const ocean = new THREE.Mesh(oceanGeo, oceanMat);
      ocean.frustumCulled = false; // 顶点位移着色器下，禁用裁剪更稳妥
      scene.add(ocean);

      // 光源
      const ambient = new THREE.AmbientLight(0xffffff, 0.35);
      scene.add(ambient);

      const sun = new THREE.DirectionalLight(0xffffff, 1.0);
      sun.position.set(60, 120, 90);
      scene.add(sun);

      // UI
      const $wind = document.getElementById("wind");
      const $height = document.getElementById("height");
      const $light = document.getElementById("light");
      const $windVal = document.getElementById("windVal");
      const $heightVal = document.getElementById("heightVal");
      const $lightVal = document.getElementById("lightVal");
      const $reset = document.getElementById("reset");

      function setVals(){
        const w = parseFloat($wind.value);
        const h = parseFloat($height.value);
        const li = parseFloat($light.value);

        $windVal.textContent = w.toFixed(1);
        $heightVal.textContent = h.toFixed(2);
        $lightVal.textContent = li.toFixed(2);

        oceanUniforms.uWind.value = w;
        oceanUniforms.uAmp.value = h;
        oceanUniforms.uLightStrength.value = li;

        sun.intensity = 0.85 * li;
        ambient.intensity = 0.28 + 0.18 * li;
        renderer.toneMappingExposure = 0.98 + 0.12 * li;
      }

      $wind.addEventListener("input", setVals);
      $height.addEventListener("input", setVals);
      $light.addEventListener("input", setVals);
      $reset.addEventListener("click", () => {
        $wind.value = "8";
        $height.value = "1.2";
        $light.value = "1.0";
        setVals();
      });
      setVals();

      // 动画
      const clock = new THREE.Clock();
      function animate(){
        const t = clock.getElapsedTime();
        oceanUniforms.uTime.value = t;

        const drift = 0.06 * Math.sin(t * 0.05);
        oceanUniforms.uSunDir.value.set(0.35 + drift, 0.72, 0.55).normalize();

        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      animate();

      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    })();
  </script>
</body>
</html>
